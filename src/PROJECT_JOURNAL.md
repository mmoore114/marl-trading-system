# Project Journal & Status: MARL Trading System

## 1. Project Objective
To build a sophisticated, professional-grade Multi-Agent Reinforcement Learning (MARL) system for trading a large universe of U.S. equities. The system is designed with a hierarchical architecture, featuring a team of "specialist agents" that report to a central "Super-Agent" for final portfolio allocation and risk management.

---

## 2. System Architecture & Strategy

The core architecture is a **Hierarchical MARL system** designed for scalability and adaptability to changing market conditions.

* **Specialist Agents (The Analysts)**: A team of agents, each an expert in a specific quantitative strategy (e.g., Momentum, Mean-Reversion, Sentiment, Risk). Each specialist analyzes the entire market through its unique lens and produces a set of conviction scores or recommended weights.
* **Super-Agent (The Portfolio Manager)**: A single, higher-level agent that takes the recommendations from all the specialist agents as its input. Its job is not to analyze raw market data, but to perform **strategy allocation**. It learns to weigh the advice of its specialists based on the current market regime and other high-level data to construct a diversified, risk-managed final portfolio.
* **Current Implementation**: Updated to use Ray RLlib for true multi-agent PPO, with specialists as separate policies and shared observations/rewards for cooperation. Environment upgraded to Gymnasium with real rewards (risk-adjusted returns, fees). Data pipeline supports EODHD/IBKR placeholders for fundamentals/news/live feeds.

---

## 3. Project File Structure & Purpose

### Root Directory
* **`.gitignore`**: Specifies which files and folders Git should intentionally ignore (e.g., `.venv`, data files, secrets).
* **`config.yaml`**: The central "control panel" for the project. Defines tickers, dates, train/val/test splits, factor definitions, reward penalties, specialist types, and model hyperparameters.
* **`.env`**: A secure, local-only file for storing secret API keys (e.g., for NewsAPI or EODHD).
* **`requirements.txt`**: An explicit list of all the Python libraries required to run this project.

### `/data`
Contains all market data.
* `/raw`: Holds the raw, unprocessed data downloaded from external sources (e.g., CSVs from yfinance/EODHD).
* `/processed`: Holds the feature-rich data files generated by the factor engine. This is the direct input for the RL environment.
* `/sentiment`: Stores processed daily news sentiment scores from sentiment_pipeline.py.

### `/models`
Contains all saved AI/ML models.
* `ppo_specialist_super_agent_final.zip`: The saved "brain" of the trained Super-Agent (SB3 format; RLlib checkpoints in models/ray_checkpoints).
* `specialist_super_agent_vec_normalize.pkl`: The normalization statistics for the environment, crucial for live trading and backtesting.
* `hmm_model_[TICKER].pkl`: The saved Hidden Markov Models for regime detection for each stock.

### `/notebooks`
Contains Jupyter Notebooks for research and analysis.
* `01_data_exploration.ipynb`: Initial data loading and plotting.
* `02_factor_analysis.ipynb`: Analysis of factor stationarity (ADF test) and market memory (Hurst Exponent).
* `03_regime_detection.ipynb`: Trains and visualizes the HMM for market regime detection (updated for multi-ticker, normalization, saving plots).

### `/src`
Contains all primary Python source code.
* **`data_pipeline.py`**: Downloads raw market data from yfinance/EODHD/IBKR; supports parallelism and retries for reliability.
* **`feature_engineering.py`**: The "factor engine." Calculates technical/fundamental/sentiment features using TA-lib and config; saves Parquet.
* **`environment.py`**: Defines the custom `TradingEnv` as MultiAgentEnv for MARL, with risk-aware rewards, fees, and specialist recs integration.
* **`train.py`**: The main training script. Uses RLlib PPO for multi-agent, with Tune for hyperparam search, checkpoints, and evaluation.
* **`backtester.py`**: Evaluates trained agent on test data with multi-agent support; generates QuantStats reports and summaries.
* **`news_fetcher.py`**: Utility to test NewsAPI/EODHD keys and fetch sample headlines.
* **`sentiment_pipeline.py`**: Fetches historical news, analyzes with FinBERT (batched/GPU), saves daily scores; parallel for tickers.
* **`PROJECT_JOURNAL.md`**: This file. A log of progress, decisions, and next steps.

---

## 4. Current Status & Immediate Next Steps

* **Last Action**: Updated all files for MARL with RLlib, Gymnasium, logging, parallelism, and EODHD/IBKR readiness (August 24, 2025). Resolved Gym deprecation, import errors, and added robustness (retries, batching).
* **Challenges & Resolutions**: Gym to Gymnasium upgrade fixed deprecation; path/import issues resolved with __init__.py and module runs; VM setup complete with SSH/GPU; added error handling/logging across pipeline.
* **Next Step**: Run full pipeline (data_pipeline -> feature_engineering -> sentiment_pipeline -> train.py -> backtester.py); tune hyperparams with Optuna; test EODHD integration and IBKR paper trading.

---

## 5. Future Plans & Roadmap

* **Data Upgrade**: Integrate EODHD for fundamentals/news/sentiment; add IBKR for live/paper trading with real-time feeds.
* **Infrastructure Upgrade**: Docker for reproducibility; CI with GitHub Actions (test/lint on push); cloud scaling with GCS for storage.
* **Advanced Features**: Add regime from HMM as env obs; specialist classes with RL policies; curriculum learning for large universes.
* **Testing & Monitoring**: Unit tests with pytest; logging with TensorBoard/Wandb for rewards/metrics.
* **Live Trading**: Build live_trader.py for IBKR execution; add tactical overlay for risk (e.g., max drawdown halt).